version: '3'
services:
    netbox:
      build:
        context: ./data/Dockerfiles/netbox/
        args:
          - BRANCH=${BRANCH-master}
     restart: always
      image: ninech/netbox:${BRANCH-latest}
      container_name: dc_netbox
      env_file: netbox.env
      depends_on:
        - postgres
      volumes:
        - ./data/netbox/nginx-config:/etc/netbox-nginx/:rw
        - ./data/netbox/static-files:/opt/netbox/netbox/static:rw

    nginx:
      image: nginx:1.11-alpine
      container_name: dc_netbox_nginx
      command: nginx -g 'daemon off;' -c /etc/netbox-nginx/nginx.conf
      depends_on:
          - netbox
#        ports:
#          - "${HTTP_BIND:-0.0.0.0}:${HTTP_PORT:-80}:${HTTP_PORT:-80}"
      volumes:
        - ./data/netbox/nginx-config:/etc/netbox-nginx/:rw
        - ./data/netbox/static-files:/opt/netbox/netbox/static:rw
      environment:
        - VIRTUAL_HOST=${NETBOX_HOSTNAME}
        - VIRTUAL_PORT=${HTTP_PORT:-80}
        - LETSENCRYPT_HOST=${NETBOX_HOSTNAME}
        - LETSENCRYPT_EMAIL=${SUPERUSER_EMAIL}

    postgres:
      image: postgres:9.6-alpine
      container_name: dc_netbox_pg
      environment:
        - POSTGRES_USER=${DB_USER}
        - POSTGRES_PASSWORD=${DB_PASSWORD}
        - POSTGRES_DB=${DB_NAME}
      volumes:
        - ./data/postgres/:/var/lib/postgresql/data:rw

